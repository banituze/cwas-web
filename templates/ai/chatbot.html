{% extends "base.html" %}
{% block title %}AI Assistant{% endblock %}
{% block page_title %}AI Assistant{% endblock %}
{% block extra_css %}
<style>
.chat-container{display:flex;flex-direction:column;height:calc(100vh - 200px);max-width:800px}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px}
.message{max-width:80%;padding:14px 18px;border-radius:16px;line-height:1.5}
.message.user{background:var(--primary);color:var(--bg-dark);align-self:flex-end;border-bottom-right-radius:4px}
.message.bot{background:var(--bg-card);border:1px solid var(--border-color);align-self:flex-start;border-bottom-left-radius:4px}
.chat-input{display:flex;gap:12px;padding:20px;background:var(--bg-card);border-top:1px solid var(--border-color);border-radius:0 0 12px 12px}
.chat-input input{flex:1;padding:14px 18px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:15px}
.chat-input input:focus{outline:none;border-color:var(--primary)}
.chat-input button{padding:14px 24px;background:var(--primary);color:var(--bg-dark);border:none;border-radius:8px;font-weight:600;cursor:pointer}
.typing{display:none;padding:10px 16px;color:var(--text-muted);font-style:italic}
</style>
{% endblock %}
{% block content %}
<div class="card chat-container">
    <div class="chat-messages" id="messages">
        <div class="message bot">Salama! I'm your CWAS assistant. I can help you with bookings, check your balance, find water sources, and answer questions. How can I help you today?</div>
        {% for m in history %}<div class="message user">{{ m.message }}</div><div class="message bot">{{ m.response|replace('\n','<br>')|safe }}</div>{% endfor %}
    </div>
    <div class="typing" id="typing">Assistant is typing...</div>
    <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>
<script>
const messages=document.getElementById('messages'),input=document.getElementById('messageInput'),typing=document.getElementById('typing');
input.addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage()});
async function sendMessage(){const msg=input.value.trim();if(!msg)return;input.value='';
messages.innerHTML+=`<div class="message user">${msg}</div>`;messages.scrollTop=messages.scrollHeight;typing.style.display='block';
try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
const data=await r.json();typing.style.display='none';messages.innerHTML+=`<div class="message bot">${data.response.replace(/\n/g,'<br>')}</div>`;messages.scrollTop=messages.scrollHeight}
catch(e){typing.style.display='none';messages.innerHTML+=`<div class="message bot">Sorry, an error occurred.</div>`}}
</script>
{% endblock %}
