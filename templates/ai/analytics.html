{% extends "base.html" %}
{% block title %}Analytics{% endblock %}
{% block page_title %}AI Analytics{% endblock %}
{% block content %}
<div class="stats-grid">
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-chart-bar"></i></div><div class="stat-content"><div class="stat-value">{{ daily_bookings|length }}</div><div class="stat-label">Days with Data</div></div></div>
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-tint"></i></div><div class="stat-content"><div class="stat-value">{{ source_stats|length }}</div><div class="stat-label">Sources Tracked</div></div></div>
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="stat-content"><div class="stat-value">{{ alerts|length }}</div><div class="stat-label">Active Alerts</div></div></div>
</div>
<div class="grid grid-2 mb-6">
    <div class="card">
        <h3 class="card-title mb-4">Booking Trends (30 Days)</h3>
        {% if daily_bookings %}
        <div style="height:200px;display:flex;align-items:flex-end;gap:4px;padding:20px 0">
            {% for d in daily_bookings %}
            <div style="flex:1;background:var(--primary);border-radius:4px 4px 0 0;min-height:10px;height:{{ [d.count * 15, 180]|min }}px" title="{{ d.booking_date }}: {{ d.count }} bookings"></div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No booking data available for the selected period.</p>
        {% endif %}
    </div>
    <div class="card">
        <h3 class="card-title mb-4">Revenue by Region</h3>
        {% if revenue_by_region %}
        {% for r in revenue_by_region %}
        <div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                <span>{{ r.region }}</span>
                <span style="font-weight:600">{{ "{:,.0f}".format(r.revenue or 0) }} Ar</span>
            </div>
            <div style="height:8px;background:var(--border-color);border-radius:4px">
                <div style="height:100%;background:var(--primary);border-radius:4px;width:{{ ((r.revenue or 0) / ((revenue_by_region[0].revenue or 1)) * 100)|int }}%"></div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-muted">No revenue data available.</p>
        {% endif %}
    </div>
</div>
<div class="card">
    <h3 class="card-title mb-4">Source Utilization</h3>
    {% if source_stats %}
    <div class="table-container">
        <table class="table">
            <thead><tr><th>Source</th><th>Capacity</th><th>Bookings</th><th>Water Distributed</th><th>Utilization</th></tr></thead>
            <tbody>
            {% for s in source_stats %}
            <tr>
                <td>{{ s.name }}</td>
                <td>{{ "{:,}".format(s.capacity_liters) }}L</td>
                <td>{{ s.booking_count }}</td>
                <td>{{ "{:,.0f}".format(s.total_booked or 0) }}L</td>
                <td>
                    <div style="width:100px;height:8px;background:var(--border-color);border-radius:4px">
                        <div style="height:100%;background:var(--primary);border-radius:4px;width:{{ [((s.total_booked or 0) / (s.capacity_liters * 30) * 100), 100]|min|int }}%"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-muted">No source data available.</p>
    {% endif %}
</div>
{% endblock %}
